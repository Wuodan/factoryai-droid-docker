#!/usr/bin/env bash
# droid-docker â€” tiny helper to start Droid with persistence
# Usage:
#   ./droid-docker                 # interactive TUI
#   ./droid-docker exec --output-format json "list files"  # headless exec
# Note: Always uses the current working directory where the script is called from

set -euo pipefail

IMAGE="wuodan/factoryai-droid"

# Always use absolute path of current working directory
CUR_PATH="$(pwd -P)"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Prevent running from the script's own directory
if [ "$CUR_PATH" = "$SCRIPT_DIR" ]; then
  echo "Error: Do not run droid-docker from its own directory." >&2
  echo "Call it from your project folder instead: /path/to/your/project/droid-docker" >&2
  exit 1
fi

# Set APP_CACHE to user home with project path
APP_CACHE="${HOME}/.factoryai-droid-docker/${CUR_PATH}"

# Create APP_CACHE directory if it doesn't exist
mkdir -p "$APP_CACHE"

# Check if .env exists, create if not
ENV_FILE="$APP_CACHE/.env"
if [ ! -f "$ENV_FILE" ]; then
  echo "FACTORY_API_KEY not found. Please enter your Factory AI API key:"
  read -s FACTORY_API_KEY

  if [ -z "$FACTORY_API_KEY" ]; then
    echo "Error: FACTORY_API_KEY cannot be empty" >&2
    exit 1
  fi

  echo "FACTORY_API_KEY='$FACTORY_API_KEY'" > "$ENV_FILE"
  chmod 600 "$ENV_FILE"
  echo "API key saved to $ENV_FILE"
else
  # Source existing .env file
  source "$ENV_FILE"
fi

# Check if FACTORY_API_KEY is set
if [ -z "${FACTORY_API_KEY:-}" ]; then
  echo "Error: FACTORY_API_KEY is not set" >&2
  exit 1
fi

# Create .gitignore if it doesn't exist
GITIGNORE_FILE="$APP_CACHE/.gitignore"
if [ ! -f "$GITIGNORE_FILE" ]; then
  cat > "$GITIGNORE_FILE" << 'EOF'
# contains API key
.env
# contains API key
**/.factory/settings.json
# can contain API keys
**/.factory/mcp.json
EOF
fi

# Handle command line arguments
if [ "$#" -ne 0 ] && [ "$1" != "droid" ]; then
  set -- droid "$@"
fi

# Start docker container
exec docker run --rm -it --init \
  -v "$APP_CACHE/.factory:/home/appuser/.factory" \
  -v "${CUR_PATH}:/home/appuser/work" \
  -e "FACTORY_API_KEY=${FACTORY_API_KEY}" \
  --network=host \
  "${IMAGE}" "$@"
